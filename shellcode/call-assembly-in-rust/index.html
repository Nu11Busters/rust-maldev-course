<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
      
    

      <title>Malware development in Rust</title>

      
      

      <!-- CSS -->
      
      <link rel="stylesheet" href=" https://nu11busters.github.io/rust-maldev-course/book.css">
      

      
      
    </head>

    <body>
        <div class="menu">
            
            
            <nav role="navigation">
                <ul>
                    
                        
                        
                            
                            <li >
                                
                                <a href=" https://nu11busters.github.io/rust-maldev-course/home/">
                                    
                                    Malware development in Rust
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href=" https://nu11busters.github.io/rust-maldev-course/about/">
                                    
                                    About us
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href=" https://nu11busters.github.io/rust-maldev-course/cargo/">
                                    
                                    Cargo
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/cargo/optimise/">
                                                    
                                                    Optimise Cargo
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/cargo/cross-compilation/">
                                                    
                                                    Cross-compilation
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/cargo/dynamic-library/">
                                                    
                                                    Dynamic library
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href=" https://nu11busters.github.io/rust-maldev-course/system/">
                                    
                                    System APIs
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/system/windows-api/">
                                                    
                                                    Windows API
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/system/libc-api/">
                                                    
                                                    Libc API
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href=" https://nu11busters.github.io/rust-maldev-course/crypto/">
                                    
                                    Cryptography
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/crypto/intro/">
                                                    
                                                    Introduction
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/crypto/rsa/">
                                                    
                                                    Asymmetric encryption
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/crypto/aes/">
                                                    
                                                    Symmetric encryption
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/crypto/sha256/">
                                                    
                                                    Hashing
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/crypto/df/">
                                                    
                                                    Diffie-Hellman
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/crypto/sockets/">
                                                    
                                                    Sockets with OpenSSL
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href=" https://nu11busters.github.io/rust-maldev-course/code_injection/">
                                    
                                    Code injection
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/code_injection/injection-with-ptrace/">
                                                    
                                                    Injection with PTRACE
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/code_injection/remote-threads/">
                                                    
                                                    CreateRemoteThread
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/code_injection/process-hollowing/">
                                                    
                                                    Process Hollowing
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href=" https://nu11busters.github.io/rust-maldev-course/obfuscation/">
                                    
                                    Obfuscation
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/obfuscation/strings/">
                                                    
                                                    Strings encryption
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/obfuscation/polymorphism/">
                                                    
                                                    Polymorphism
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/obfuscation/metamorphism/">
                                                    
                                                    Metamorphism
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/obfuscation/auto-remove/">
                                                    
                                                    Self deletion
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/obfuscation/dynamic-imports/">
                                                    
                                                    Dynamic imports
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href=" https://nu11busters.github.io/rust-maldev-course/evasion/">
                                    
                                    Evasion
                                </a>
                                
                                    <ul>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/evasion/query-wmi/">
                                                    
                                                    Query wmi
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/evasion/anti-debug-with-ptrace/">
                                                    
                                                    Anti-debug with PTRACE
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/evasion/anti-debug-with-isdebuggerpresent/">
                                                    
                                                    IsDebuggerPresent
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/evasion/detect-sandbox/">
                                                    
                                                    Detect sandbox
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/evasion/fileless-execution/">
                                                    
                                                    Fileless on Linux
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/evasion/direct-syscalls/">
                                                    
                                                    Direct syscall
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/evasion/hook-detection/">
                                                    
                                                    Hook detection
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/evasion/hells/">
                                                    
                                                    Hell&#x27;s Gate
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/evasion/patch-etw/">
                                                    
                                                    Patch ETW
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href=" https://nu11busters.github.io/rust-maldev-course/shellcode/">
                                    
                                    Shellcode
                                </a>
                                
                                    <ul>
                                        
                                            <li class="active">
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/shellcode/call-assembly-in-rust/">
                                                    
                                                    Call assembly in Rust
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/shellcode/exec-shellcode-in-local/">
                                                    
                                                    Execute shellcode in local process
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/shellcode/generate-shellcode-for-linux/">
                                                    
                                                    Generate shellcode for Linux
                                                </a>
                                            </li>
                                        
                                            <li >
                                                <a href=" https://nu11busters.github.io/rust-maldev-course/shellcode/generate-shellcode-for-windows/">
                                                    
                                                    Generate shellcode for Windows
                                                </a>
                                            </li>
                                        
                                    </ul>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href=" https://nu11busters.github.io/rust-maldev-course/conclusion/">
                                    
                                    Conclusion
                                </a>
                                
                            </li>
                        
                            
                            <li >
                                
                                <a href=" https://nu11busters.github.io/rust-maldev-course/credits/">
                                    
                                    Credits and ressources
                                </a>
                                
                            </li>
                        
                    
                </ul>
            </nav>
            
            
        </div>

        <div class="page">
            <div class="page__header">
                <div class="menu-icon">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
                
                <span class="search-icon">🔎</span>
                
            </div>

            <div class="page__content">
                
                <div class="search-container">
                    <input id="search" type="search" placeholder="Search..">
                    <div class="search-results">
                        <div class="search-results__header"></div>
                        <ul class="search-results__items"></ul>
                    </div>
                </div>
                
                <div class="book-content">
                    
    <h1>Call assembly in Rust</h1>
    <p>Please note!</p>
<p>It is important to note that this course requires a basic knowledge of assembler concepts. Understand the structure of an assembler instruction, registers, memory, etc.</p>
<h2 id="calling-assembler-in-rust">Calling assembler in Rust<a class="zola-anchor" href="#calling-assembler-in-rust" aria-label="Anchor link for: calling-assembler-in-rust">🔗</a></h2>
<p>Assembler is a low-level language that represents the instructions directly executed by a computer's processor. Each instruction generally corresponds to a specific hardware operation.</p>
<h3 id="the-benefits-of-assembler-with-rust">The benefits of assembler with Rust<a class="zola-anchor" href="#the-benefits-of-assembler-with-rust" aria-label="Anchor link for: the-benefits-of-assembler-with-rust">🔗</a></h3>
<p>Writing assembler code in Rust is interesting for a number of reasons. First of all, for development purposes, there's great interest, as you can manipulate low-level instructions while taking advantage of Rust's modern features. Rust's clear, expressive syntax simplifies the writing of assembler instructions, making it more accessible even to those who are not assembler experts. But also, shellcodes can be written in a more structured way, improving code maintenance over time. Of course, there are many other advantages to using Rust for assembler, depending on your needs. To summarize, assembler in Rust offers a balanced approach to leveraging the power of assembler while mitigating the challenges associated with using it directly.</p>
<h3 id="how-to-call-assembler-in-rust">How to call assembler in Rust?<a class="zola-anchor" href="#how-to-call-assembler-in-rust" aria-label="Anchor link for: how-to-call-assembler-in-rust">🔗</a></h3>
<p>To illustrate my point, let's take the following assembler code as an example:</p>
<pre style="background-color:#eff1f5;color:#4f5b66;"><code><span>section .data
</span><span>   message db &#39;Hello world!&#39;, 0
</span><span>   len equ $ - message
</span><span>
</span><span>section .text
</span><span>   global _start
</span><span>
</span><span>_start:
</span><span>
</span><span>   ; Load syscall number sys_write (1) into rax
</span><span>   mov rax, 1
</span><span>
</span><span>   ; Load file descriptor for stdout (1) into rdi
</span><span>   mov rdi, 1
</span><span>
</span><span>   lea rsi, [message]
</span><span>   mov rdx, len
</span><span>
</span><span>   ; System call sys_write
</span><span>   syscall
</span><span>
</span><span>   ; End of program - Load sys_exit syscall number (60) into rax
</span><span>   mov rax, 60
</span><span>
</span><span>   Load output code 0 into rdi
</span><span>   xor rdi, rdi
</span><span>
</span><span>   ; System call sys_exit
</span><span>   syscall
</span></code></pre>
<p>This code displays :</p>
<p><code>Hello world!</code></p>
<p>In the console, type the command :</p>
<p><code>nasm -f elf64 hello.asm -o hello.o &amp;&amp; ld hello.o -o hello &amp;&amp; ./hello</code></p>
<p>Next, you'll need to change the Rust compiler version from stable to nightly. Because the :</p>
<p><code>asm!</code></p>
<p>is currently experimental and requires the nightly version of the Rust compiler. To do this, simply take the Optimizing Cargo course.</p>
<p>Here's an example of how to configure Cargo.toml:</p>
<pre style="background-color:#eff1f5;color:#4f5b66;"><code><span>[package] name = &quot;hello
</span><span>version = &quot;0.1.0
</span><span>edition = &quot;2021&quot;
</span><span>
</span><span>[dependencies]
</span><span>
</span><span>[profile.release]
</span><span>opt-level = &quot;s&quot;
</span><span>strip = true
</span><span>lto = true
</span><span>panic = &quot;abort
</span></code></pre>
<p>Now we can move on to the main part of this course, calling assembler in Rust. We're going to take the assembler code we saw earlier and integrate it into our Rust code. Here's the basis of our program:</p>
<pre style="background-color:#eff1f5;color:#4f5b66;"><code><span>use std::arch::asm;
</span><span>
</span><span>fn main() {
</span><span>   //Declaration of the string to be displayed in the console
</span><span>   let message = String::from(&quot;Hello world!\n&quot;);
</span><span>   unsafe {
</span><span>      asm!(
</span><span>         //Your assembler code will be here
</span><span>      )
</span><span>   }
</span><span>}
</span></code></pre>
<p>In Rust, arguments can be called up in a different order than in assembler. In our case, the arrangement of arguments for a system call is :
<code>syscall</code></p>
<p>may vary according to the system API convention used. In the case of the Linux x86-64 system API, the arguments for syscall :
<code>write</code></p>
<p>are generally passed in the rdi, rsi, rdx, r10, r8 and r9 registers, in that order.
In our assembly code, the order of the arguments conforms to this convention:</p>
<pre style="background-color:#eff1f5;color:#4f5b66;"><code><span>Load syscall number sys_write (1) into rax
</span><span>mov rax, 1
</span><span>; Load file descriptor for stdout (1) into rdi
</span><span>mov rdi, 1
</span><span>; Load message pointer into rsi
</span><span>lea rsi, [message]
</span><span>; Load message length into rdx
</span><span>mov rdx, len
</span><span>; System call sys_write
</span><span>syscall
</span></code></pre>
<p>In assembly code, loading the pointer to the message :</p>
<p><code>lea rsi, [message]</code></p>
<p>And the length of the message:</p>
<p><code>mov rdx, len</code></p>
<p>Performed before the system call</p>
<p><code>syscall</code></p>
<p>In accordance with Linux x86-64 convention.</p>
<p>However, the situation is different in Rust code. In the case of the :</p>
<p><code>asm!</code></p>
<p>Constraints:</p>
<p><code>in</code></p>
<p>Specify operands that are inputs to the assembly instruction, but this does not necessarily determine the order of evaluation. In your Rust code, in constraints are specified after syscall:</p>
<pre style="background-color:#eff1f5;color:#4f5b66;"><code><span>asm!(
</span><span>   &quot;mov rax, 1&quot;,
</span><span>   &quot;mov rdi, 1&quot;,
</span><span>   &quot;syscall&quot;,
</span><span>   in(&quot;rsi&quot;) message.as_ptr(),
</span><span>   in(&quot;rdx&quot;) message.len(),
</span><span>)
</span></code></pre>
<p>The evaluation order can change depending on the compiler and the optimizations performed. This can sometimes lead to a change in the apparent order of in constraints compared to assembly code. If we take a closer look :</p>
<p><code>&quot;mov rax, 1&quot;</code></p>
<p>This instruction loads the syscall number into rax.</p>
<p><code>&quot;mov rdi, 1&quot;</code></p>
<p>This instruction loads the stdout file descriptor into rdi.</p>
<p><code>&quot;syscall&quot;</code></p>
<p>This instruction performs the syscall write. At this point, the values in rsi and rdx will be used as parameters for syscall.</p>
<p><code>in(&quot;rsi&quot;) message.as_ptr()</code></p>
<p>This constraint specifies that rsi is an input and loads the address of the beginning of the message.as_ptr() string into rsi. This is important because rsi is an input register for syscall.</p>
<p><code>in(&quot;rdx&quot;) message.len()</code></p>
<p>This constraint specifies that rdx is an input and loads the length of the message.len() string into rdx. It's also crucial because rdx is used as an input parameter for syscall.</p>
<p>However, as long as the constraints are correctly specified and the values are correctly loaded into the registers before syscall, the result should be correct. It's important to note that specifying in constraints after syscall in Rust code doesn't affect the actual order in which operations are evaluated, and the compiler will ensure that the necessary values are correctly loaded before the system call.
So here's our final program:</p>
<pre style="background-color:#eff1f5;color:#4f5b66;"><code><span>use std::arch::asm;
</span><span>
</span><span>fn main() {
</span><span>   let message = String::from(&quot;Hello world!\n&quot;);
</span><span>   unsafe {
</span><span>      asm!(
</span><span>         &quot;mov rax, 1&quot;,
</span><span>         &quot;mov rdi, 1&quot;,
</span><span>         &quot;syscall&quot;,
</span><span>         in(&quot;rsi&quot;) message.as_ptr(),
</span><span>         in(&quot;rdx&quot;) message.len(),
</span><span>      )
</span><span>   }
</span><span>}
</span></code></pre>
<p>Finally, we can see that calling assembler in Rust is pretty easy. You just need to pay attention to the evaluation order and the conventions of the system APIs. To play with variables, use the various operands available in Rust:</p>
<p><code>in, out, inout, inlateout, lateout, etc.</code></p>
<p>The in operand is used to specify that the values of the specified registers will be read by the assembler instruction. This means that the register values will be used as input for the assembler instruction.
Example:</p>
<p><code>asm!(&quot;mov $0, $1&quot; : &quot;=r&quot;(output) : &quot;r&quot;(input));</code></p>
<p>The out operand is used to specify that the specified register values will be written by the assembler instruction. This means that the register values will be modified by the assembler instruction and returned as output.
Example :</p>
<p><code>asm!(&quot;mov $0, $1&quot; : &quot;=r&quot;(output) : &quot;r&quot;(input));</code></p>
<p>The inout operand combines in and out. It specifies that the values of specified registers will be read as input and written as output by the assembler instruction.
Example:</p>
<p><code>asm!(&quot;add $0, $1&quot; : &quot;=r&quot;(result) : &quot;r&quot;(value));</code></p>
<p>The inlateout operand is similar to inout, but indicates that the write operation (out) can be delayed until the end of the asm! block.
Example:</p>
<p><code>asm!(&quot;add $0, $1&quot; : &quot;=&amp;r&quot;(result) : &quot;r&quot;(value));</code></p>
<p>The lateout operand is used to specify that the write operation (out) can be delayed until the end of the asm! block, without any initial read operation.
Example:</p>
<p><code>asm!(&quot;mov $0, $1&quot; : &quot;=&amp;r&quot;(output));</code></p>
<p>In these examples, $0, $1, etc. are substitution operands used to reference the register values specified in the operand list. The symbols &quot;=r&quot; and &quot;r&quot; define the type and access mode of the registers.</p>
<p>All the code seen in this course is available as a file on the following page.</p>


                </div>
            </div>

            <div class="prev-link">
                
    
        
        
        <a class="previous" href=" https://nu11busters.github.io/rust-maldev-course/shellcode/"><</a>
    

            </div>

            <div class="next-link">
                
    
        <a class="next" href=" https://nu11busters.github.io/rust-maldev-course/shellcode/exec-shellcode-in-local/">></a>
    

            </div>
        </div>

        
            
            <script type="text/javascript" src=" https://nu11busters.github.io/rust-maldev-course/elasticlunr.min.js"></script>
            <script type="text/javascript" src=" https://nu11busters.github.io/rust-maldev-course/search_index.en.js"></script>
            
            <script type="text/javascript" src=" https://nu11busters.github.io/rust-maldev-course/book.js"></script>
        
    </body>

</html>
